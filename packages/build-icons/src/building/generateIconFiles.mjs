import fs from 'fs'
import path from 'path'
import prettier from 'prettier'
import { readSvg, toPascalCase } from '../utils/helpers.mjs'

export default ({
  iconNodes,
  outputDirectory,
  template,
  showLog = true,
  iconFileExtension = '.js',
  pretty = true,
  iconsDir,
  registryDir,
  iconMetaData,
}) => {
  const icons = Object.keys(iconNodes)
  const iconsDistDirectory = path.join(outputDirectory, `icons`)

  if (!fs.existsSync(iconsDistDirectory)) {
    fs.mkdirSync(iconsDistDirectory)
  }

  let registryIndex = `// @ts-nocheck
// This file is autogenerated by icons-build/src/building/generateIconFiles.mjs
// Do not edit this file directly.
import * as React from "react"

export const Index: Record<string, any> = [`

  const registryOutput = path.join(registryDir, 'index.tsx')

  const writeIconFiles = icons.map(async (iconName, i) => {
    const location = path.join(iconsDistDirectory, `${iconName}${iconFileExtension}`)

    const componentName = toPascalCase(iconName)

    let { children } = iconNodes[iconName]
    children = children.map(({ name, attributes }) => [name, attributes])

    const getSvg = () => readSvg(`${iconName}.svg`, iconsDir)
    // const { deprecated = false } = iconMetaData[iconName]
    const deprecated = false

    const elementTemplate = template({ componentName, iconName, children, getSvg, deprecated })
    const output = pretty
      ? prettier.format(elementTemplate, {
          singleQuote: true,
          trailingComma: 'all',
          printWidth: 100,
          parser: 'babel',
        })
      : elementTemplate

    const rawSvg = JSON.stringify(readSvg(`${iconName}.svg`, iconsDir))

    // build registry of Icon
    // this is used for ./apps/design-system to display icons

    registryIndex += `\n{`

    registryIndex += `
  name: "${iconName}",
  componentName: componentName,
  deprecated,
  raw: output,
  component: React.lazy(() => import('icons/src/icons/${iconName}')),
  import: "import { ${componentName} } from 'icons'",
  svg: ${JSON.stringify(readSvg(`${iconName}.svg`, iconsDir))},
  jsx: ${JSON.stringify(`import { ${componentName} } from "icons"
  <${componentName}/>
  `)}`

    if (i !== icons.length - 1) {
      registryIndex += `\n},`
    }

    console.log('Created ' + componentName)
    await fs.promises.writeFile(location, output, 'utf-8')
  })

  async function writeRegistry() {
    console.log(registryIndex)

    registryIndex += `\n}`
    // close index
    registryIndex += `\n]`

    await fs.promises.writeFile(registryOutput, registryIndex, 'utf-8')
    console.log('Successfully created registry at', registryOutput)
  }

  Promise.all([writeIconFiles])
    .then(() => writeRegistry())
    .then(() => {
      if (showLog) {
        console.log('Successfully built', icons.length, 'icons.')
      }
    })
    .catch((error) => {
      throw new Error(`Something went wrong generating icon files,\n ${error}`)
    })
}
